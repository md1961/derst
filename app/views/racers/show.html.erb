<div class="racers_show">
  <div id="name_and_traits">
    <%= racer_name_display(@racer) %>
    <span class="sex"><%= racer_sex_display(@racer) %></span>
    <%= render 'traits' %>

    <div id="racer_menu" class="racers_racers esc_hideable" hidden>
      <table class="table_base">
        <% prev_racer = nil -%>
        <% Racer.active.where.not(stable: nil).older_first.each.with_index(1) do |racer, index| -%>
          <% next unless racer.in_stable? -%>
          <tr class="<%= prev_racer&.age.to_i > racer.age ? 'border_top_thick' : '' %>">
            <% prev_racer = racer -%>
            <%= render partial: 'racer', locals: {racer: racer, index: index, f: @racer} %>
          </tr>
        <% end -%>
      </table>
    </div>
  </div>

  <div id="results_and_conditions">
    <% if @racer.stable -%>
      <%= render 'results' %>
      <div class="notice">
        <%= notice(@racer.ranch) %>
      </div>
      <%= render 'conditions' %>
    <% else -%>
      <%= render partial: 'mating', locals: {mare: @racer.mother, sire: @racer.father} %>
    <% end -%>

    <div class="links">
      <% unless @editing -%>
        <%= form_for_weekly(@racer) %>
      <% end -%>
      <span class="weight_best"><%= "ベスト #{@racer.weight_best}kg" %></span>

      <%= link_to 'Back', ranch_path(@racer.ranch, main_display: @main_display), data: {shortcut: 'b'}, tabindex: -1 %>
      <% if @prev_racer && @next_racer -%>
        <%= link_to "<[#{racer_with_race_display(@prev_racer)}]".html_safe, @prev_racer, id: 'to_prev_racer',
                      class: @prev_racer.expecting_race? ? 'expecting_race' : '' , tabindex: -1 %>
        <span class="count">
          <%= "#{Racer.in_stable.count { |r| r.condition.nil? }} / #{Racer.in_stable.count}" %>
        </span>
        <%= link_to "[#{racer_with_race_display(@next_racer)}]>".html_safe, @next_racer, id: 'to_next_racer',
                      class: @next_racer.expecting_race? ? 'expecting_race' : '' , tabindex: -1 %>
      <% end -%>

      <% course_staying = @racer.course_staying
         course_last = @racer.results.last&.race&.course -%>
      <% if course_staying || (@racer.in_stable? && course_last&.stayable?) -%>
        <div class="button_to_trip">
          <% label = course_staying ? '帰厩' : "[#{course_last}] へ遠征" -%>
          <%= button_to label, trip_racer_path(@racer), method: :patch, tabindex: -1 %>
          <% if course_staying -%>
            <% clazz = @racer.ranch.courses_with_races.include?(course_staying) ? '' : 'no_race' -%>
            <span class="course_staying <%= clazz %>"><%= "[#{course_staying}] に滞在中" %></span>
          <% end -%>
        </div>
      <% end -%>
    </div>
  </div>

  <% if @racer.is_active && @racer.stable && !@racer.expecting_race? && @result_id_to_edit&.zero? -%>
    <div id="race_candidates">
      <div class="links">
        <% label, path = @includes_overgrade ? ['格上挑戦せず', @racer] \
                                             : ['格上挑戦', racer_path(@racer, includes_overgrade: true)] -%>
        <%= link_to label, path, tabindex: -1 %>
      </div>

      <table class="table_base">
        <tbody>
          <% current_week = @racer.ranch.month_week
             week_since = @racer.results.last&.race&.month_week
             week_since = current_week if week_since.nil? || @racer.in_ranch || current_week - week_since >= 5
             races_by_week = @racer.race_candidates(includes_overgrade: @includes_overgrade).group_by { |race|
               race.month_week
             }
             month_week = current_week -%>
          <% @weeks_for_race_candidates.times do -%>
            <% races = races_by_week[month_week] || []
               races.sort_by! { |r| (r.course.area.location - @racer.stable.center.area.location).abs } -%>
            <% if races.empty? -%>
              <tr>
                <td class="numeric <%= month_week == current_week ? 'current' : '' %>">
                  <%= month_week %>
                </td>
                <td colspan="4" class="centered">---</td>
              </tr>
            <% else -%>
              <tr>
                <td rowspan="<%= races.size %>" class="numeric <%= month_week == current_week ? 'current' : '' %>">
                  <%= month_week %>
                </td>
                <td rowspan="<%= races.size %>" class="numeric">
                  <% weeks_later = month_week - week_since -%>
                  <%= weeks_later.zero? ? '-' : "#{weeks_later}w" %>
                </td>
                <%= race_display(races.first, @racer, displays_target_button: true) %>
              </tr>
              <% races[1 .. -1].each do |race| -%>
                <tr>
                  <%= race_display(race, @racer, displays_target_button: true) %>
                </tr>
              <% end -%>
            <% end -%>
            <% month_week = month_week.next -%>
          <% end -%>
        </tbody>
      </table>
    </div>
  <% end -%>
</div>
