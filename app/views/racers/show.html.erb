<div class="racers_show">
  <div class="name">
    <%= @racer.name %>
  </div>
  <div class="tables">
    <div id="traits_and_results">
      <div id="traits">
        <table class="table_base">
          <tr>
            <th>体重</th>
            <td class="numeric"><%= "#{@racer.weight_best}kg" %></td>
          </tr>
            <th>父</th>
            <% father = @racer.father -%>
            <td><%= safe_join([father&.name, sire_trait_display(father)], '<br>'.html_safe) %></td>
          </tr>
          <tr>
            <% mother = @racer.mother
               mating = Mating.new(mother, father)
               inbreed = mating.inbreed_display.gsub(', ', '<br>').html_safe -%>
           <td colspan="2">
             <%= inbreed.blank? ? '（アウトブリード）' : inbreed %>
           </td>
          </tr>
          <tr>
            <td colspan="2">
              <%= "ニックス #{mating.nicks? ? '○' : '×'}、面白 #{mating.interesting? ? '○' : '×'}" %>
            </td>
          </tr>
          <tr>
            <th>母</th>
            <td><%= safe_join([mother&.name, mare_trait_display(mother)], '<br>'.html_safe) %></td>
          </tr>
          <tr>
            <th>母父</th>
            <% father = @racer.mother&.father -%>
            <td><%= safe_join([father&.name, sire_trait_display(father)], '<br>'.html_safe) %></td>
          </tr>
        </table>
        <table class="table_base">
          <tr>
            <th>２歳時</th>
            <td><%= @racer.comment_age2 %></td>
          </tr>
          <tr>
            <th>３歳時</th>
            <td><%= @racer.comment_age3 %></td>
          </tr>
          <tr>
            <th>厩舎</th>
            <td class="centered" title="<%= @racer.stable&.jockeys&.join('　') %>">
              <%= @racer.stable %>
            </td>
          </tr>
          <tr>
            <th>主戦騎手</th>
            <td class="centered">
              <%= @racer.stable&.jockeys&.join('、') %>
            </td>
          </tr>
        </table>
        <table class="table_base">
          <tr>
            <th>
            <td class="centered">
              <%= "#{@racer.age}歳 #{@racer.grade}" %>
            </td>
          </tr>
          <tr>
            <th>本賞金</th>
            <td class="numeric">
              <%= "#{@racer.net_prize}万円" %>
            </td>
          </tr>
          <tr>
            <th>
            <td class="centered">
              <%= @racer.place_records.join('-') %>
            </td>
          </tr>
        </table>
      </div>

      <table id="results" class="table_base">
        <thead>
          <th colspan="4">
          <% result_attr_names.each do |name| -%>
            <th><%= Result.human_attribute_name(name) %></th>
          <% end -%>
          <th>
        </thead>
        <tbody>
          <% @racer.results.each do |result| -%>
            <% race = result.race -%>
            <tr>
              <td class="numeric"><%= "#{race.month}.#{race.week}" %></td>
              <td><%= race.course %></td>
              <td><%= race_name_display(race) %></td>
              <td><%= race_distance_display(race) %></td>
              <% if result.place.nil? || result.id == @result_id_to_edit -%>
                <%= form_with model: result, local: true do |f| %>
                  <%= render partial: 'result', locals: {result: result, f: f} %>
                <tr>
                  <td colspan="22" class="numeric"><%= f.submit %></td>
                <% end -%>
                  <td colspan="2" class="numeric">
                    <%= link_to 'Cancel', @racer %>
                  </td>
                  <td class="numeric">
                    <%= button_to '削除', result, method: :delete, class: 'destroy', tabindex: -1 %>
                  </td>
                </tr>
              <% else -%>
                <%= render partial: 'result', locals: {result: result, f: nil} %>
                <td><%= link_to 'e', edit_result_path(result), tabindex: -1 %></td>
              <% end -%>
            </tr>
            <% if post_race = result.post_race -%>
              <% if @post_race -%>
                <td colspan="24">
                  <%= render partial: 'post_race_form', locals: {post_race: @post_race} %>
                </td>
                <td colspan="2">
                  <%= button_to '削除', @post_race, method: :delete, class: 'destroy' %>
                </td>
              <% else -%>
                <td colspan="25" class="centered">
                  <%= post_race.comment %>
                </td>
                <td><%= link_to 'e', edit_post_race_path(post_race), tabindex: -1 %></td>
              <% end -%>
            <% end -%>
          <% end -%>

          <% if @racer.is_active -%>
            <tr>
              <% if @racer.expecting_race? -%>
                <td colspan="16">
              <% else -%>
                <%= form_with url: create_result_racer_path(@racer), local: true do |f| %>
                  <td class="numeric"><%= @racer.ranch.month_week %></td>
                  <td colspan="15">
                    <%= select_tag :race_id, race_options_for_select_for(@racer) %>
                    <%= f.submit %>
                  </td>
                <% end -%>
              <% end -%>

              <td colspan="10">
                <%= render partial: 'post_race_form', locals: {post_race: PostRace.new} %>
              </td>
            </tr>
          <% end -%>
        </tbody>
      </table>

      <table id="conditions" class="table_base">
        <thead>
          <tr>
            <th>
            <% (1 .. 12).each do |month| -%>
              <th colspan="4" class="centered"><%= "#{month}月" %></th>
            <% end -%>
          </tr>
          <tr>
            <th>
            <% (12 * 4).times do |w| -%>
              <th><%= w % 4 + 1 %></th>
            <% end -%>
          </tr>
        </thead>
        <tbody>
          <% (3 .. @racer.age).each do |age| -%>
            <tr>
              <th><%= "#{age}歳" %></th>
              <% (12 * 4).times do |w| -%>
                <td class="centered"></td>
              <% end -%>
            </tr>
          <% end -%>
        </tbody>
      </table>

      <%= form_with url: weekly_racer_path(@racer), local: true do |f| -%>
        <%= select_tag :condition, options_for_select(%w[- ◎ ○ ↑ △ ▽ × 太 重]) %>
        <%= submit_tag %>
      <% end -%>

      <div class="links">
        <%= link_to 'Back', @racer.ranch, data: {shortcut: 'b'} %>
        <% if @prev_racer && @next_racer -%>
          <%= link_to "<(#{@prev_racer})", @prev_racer, id: 'to_prev_racer', tabindex: -1 %>
          <%= link_to "(#{@next_racer})>", @next_racer, id: 'to_next_racer', tabindex: -1 %>
        <% end -%>
      </div>
    </div>

    <% if @racer.is_active && !@racer.expecting_race? && @result_id_to_edit.zero? -%>
      <div id="race_candidates">
        <div class="links">
          <% label, path = @includes_overgrade ? ['格上挑戦せず', @racer] \
                                               : ['格上挑戦', racer_path(@racer, includes_overgrade: true)] -%>
          <%= link_to label, path, tabindex: -1 %>
        </div>

        <table class="table_base">
          <tbody>
            <% @racer.race_candidates(includes_overgrade: @includes_overgrade).group_by { |race|
                 race.month_week
               }.each do |month_week, races| -%>
              <% races.sort_by! { |r| (r.course.area.location - @racer.stable.center.area.location).abs } -%>
              <tr>
                <td rowspan="<%= races.size %>" class="numeric">
                  <%= month_week %>
                </td>
                <td rowspan="<%= races.size %>" class="numeric">
                  <% weeks_later = month_week - @racer.ranch.month_week -%>
                  <%= weeks_later.zero? ? '-' : "#{weeks_later}w" %>
                </td>
                <%= race_display(races.first, @racer, displays_target_button: true) %>
              </tr>
              <% races[1 .. -1].each do |race| -%>
                <tr>
                  <%= race_display(race, @racer, displays_target_button: true) %>
                </tr>
              <% end -%>
              <% break if weeks_later >= @weeks_for_race_candidates -%>
            <% end -%>
          </tbody>
        </table>
      </div>
    <% end -%>
  </div>
</div>
