<%
  is_menu = false
  is_current_racer = false
  if f.is_a?(Racer)
    is_menu = true
    current_racer = f
    f = nil
    is_current_racer = racer == current_racer
    @racer_id_to_edit = is_current_racer ? -1 : 0
  end

  if index < 10
    shortcut_show = index.to_s
    shortcut_edit = %w[nil ! = # $ % & ' ( )][index]
  else
    shortcut_show = ('a'.ord + index - 10).chr
    shortcut_edit = shortcut_show.upcase
  end
-%>

<td class="<%= racer.expecting_race? ? 'expecting_race' \
             : racer.in_ranch ? 'in_ranch' \
             : !racer.stable  ? 'not_stabled' : '' %>">
  <%= link_to_if @racer_id_to_edit.zero?, shortcut_show.upcase, racer,
                                          data: {shortcut: shortcut_show}, tabindex: -1 %></td>
<% unless is_menu -%>
  <td>
    <%= link_to_if @racer_id_to_edit.zero?, 'e', ranch_path(@ranch, racer_id_to_edit: racer),
                                            data: {shortcut: shortcut_edit}, tabindex: -1 %>
  </td>
<% end -%>

<td class="<%= is_current_racer ? 'current_racer' : '' %>">
  <%= racer_name_display(racer, f) %>
</td>

<% if is_menu -%>
  <td class="<%= racer.in_ranch || racer.condition ? '' : 'no_condition' %> centered">
    <%= racer.in_ranch ? '' : (racer.condition || racer.last_condition) %>
  </td>
<% else -%>
  <td><%= racer_sex_display(racer) %></td>
  <td class="numeric"><%= "#{racer.age}æ­³" %></td>
  <%= racer_attr_display_in_td(racer, :grade, f) %>
  <td class="numeric"><%= racer.stable ? racer.net_prize : nil %></td>
  <% racer_attr_names.each do |name| -%>
    <%= racer_attr_display_in_td(racer, name, f) %>
  <% end -%>

  <% if f -%>
    <%= hidden_field_tag :ranch_id, @ranch.id %>

    <td>
    <td>
      <%= f.submit %>
      <%= link_to 'Cancel', @ranch, data: {shortcut: 'b'} %>
    </td>
  <% else -%>
    <td class="numeric <%= racer.in_ranch ? 'in_ranch' : '' %>">
      <% results = racer.results.find_all(&:place) -%>
      <%= results.empty? && !racer.in_ranch \
            ? "" \
            : "#{@ranch.month_week - (racer.in_ranch ? racer.in_ranch.month_week
                                                     : results.last.race.month_week)}w" %>
    </td>
    <% unless racer.stable -%>
      <td>
    <% else -%>
      <td>
        <%= button_to_graze(racer) %>
      </td>
    <% end -%>
    <% racer.coming_races.map(&:race).sort_by { |race|
         race.month_week.ordering_from(@ranch.month_week)
       }.each do |race| -%>
      <% n_weeks_between = racer.results.empty? ? nil \
                              : "#{race.month_week - racer.results.last.race.month_week}w" -%>
      <td class="numeric"><%= race.month_week %></td>
      <td class="numeric"><%= n_weeks_between %></td>
      <%= race_display(race, racer) %>
    <% end -%>
  <% end -%>
<% end -%>
